---
import Layout from '../../layouts/Layout.astro'
---

<Layout>
  <div class="mt-8 mb-16">
    <h1 class="text-3xl font-bold text-zinc-900 dark:text-zinc-100">
      Online Readings
    </h1>
    <p class="text-base text-zinc-900 dark:text-zinc-100">
      Things from around the web I put on Kobo to read (or <em>skim</em>).
    </p>
  </div>
  <div id="charts-container">
    <p id="charts-loading" class="text-zinc-500 dark:text-zinc-400">
      Loading data…
    </p>
  </div>
</Layout>

<script>
  const START_YEAR = 2025
  const MONTH_NAMES = [
    'January',
    'February',
    'March',
    'April',
    'May',
    'June',
    'July',
    'August',
    'September',
    'October',
    'November',
    'December',
  ]

  const daysInMonth = (year: number, month: number) =>
    new Date(year, month, 0).getDate()

  const processYearData = (
    year: number,
    data: Record<string, Record<string, any[]>>,
  ) => {
    const months: {
      monthNum: number
      name: string
      labels: number[]
      counts: number[]
      tooltips: string[][]
      articlesByDay: { day: number; articles: { title: string; url: string; domain: string }[] }[]
    }[] = []
    const monthKeys = Object.keys(data).sort()

    for (const monthKey of monthKeys) {
      const monthNum = parseInt(monthKey, 10)
      const totalDays = daysInMonth(year, monthNum)
      const counts = new Array(totalDays).fill(0)
      const tooltips: string[][] = Array.from({ length: totalDays }, () => [])
      const articlesByDay: {
        day: number
        articles: { title: string; url: string; domain: string }[]
      }[] = []
      const monthData = data[monthKey]

      for (const [day, articles] of Object.entries(monthData)) {
        const dayIndex = parseInt(day, 10) - 1
        if (dayIndex >= 0 && dayIndex < totalDays) {
          counts[dayIndex] = articles.length
          const parsed = articles.map((a: any) => {
            const title = a.title || 'Untitled'
            let domain = ''
            try {
              domain = new URL(a.url).hostname.replace(/^www\./, '')
            } catch {}
            return { title, url: a.url, domain }
          })
          tooltips[dayIndex] = parsed.map((p) => {
            const truncated =
              p.title.slice(0, 75) + (p.title.length > 30 ? '…' : '')
            return `${truncated} (${p.domain})`
          })
          articlesByDay.push({ day: parseInt(day, 10), articles: parsed })
        }
      }

      articlesByDay.sort((a, b) => a.day - b.day)

      months.push({
        monthNum,
        name: MONTH_NAMES[monthNum - 1],
        labels: Array.from({ length: totalDays }, (_, i) => i + 1),
        counts,
        tooltips,
        articlesByDay,
      })
    }

    return months
  }

  const createChart = (
    canvas: HTMLCanvasElement,
    labels: number[],
    counts: number[],
    tooltips: string[][],
  ) => {
    const isDark = document.documentElement.classList.contains('dark')
    const textColor = isDark ? '#a1a1aa' : '#71717a'

    new (window as any).Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            data: counts,
            backgroundColor: '#14b8a6',
            borderRadius: 2,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            bodyFont: { size: 16 },
            displayColors: false,
            callbacks: {
              title: () => '',
              label: (item: any) => {
                const dayTitles = tooltips[item.dataIndex]
                if (!dayTitles || dayTitles.length === 0) return ''
                return dayTitles.map((t: string) => `• ${t}`)
              },
            },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1, color: textColor },
            grid: {
              color: isDark ? 'rgba(161,161,170,0.1)' : 'rgba(0,0,0,0.06)',
            },
          },
          x: {
            ticks: { color: textColor, maxRotation: 0 },
            grid: { display: false },
          },
        },
      },
    })
  }

  const fetchYearData = async (year: number) => {
    try {
      const res = await fetch(`/data/instapaper/${year}/data.json`)
      if (!res.ok) return null
      return await res.json()
    } catch {
      return null
    }
  }

  const waitForChartJs = () => {
    return new Promise<void>((resolve) => {
      if ((window as any).Chart) {
        resolve()
        return
      }
      const interval = setInterval(() => {
        if ((window as any).Chart) {
          clearInterval(interval)
          resolve()
        }
      }, 100)
    })
  }

  const escapeHtml = (str: string) =>
    str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')

  const renderArticleList = (month: ReturnType<typeof processYearData>[number]) => {
    const totalArticles = month.counts.reduce((s: number, c: number) => s + c, 0)
    if (month.articlesByDay.length === 0) return ''

    return `
      <details class="mt-3">
        <summary class="cursor-pointer text-sm text-zinc-500 dark:text-zinc-400 hover:text-teal-500 dark:hover:text-teal-400">
          ${totalArticles} article${totalArticles !== 1 ? 's' : ''}
        </summary>
        <div class="mt-2 space-y-3">
          ${month.articlesByDay.map(({ day, articles }) => `
            <div class="ml-4">
              <p class="text-sm font-medium text-zinc-500 dark:text-zinc-400">
                ${String(day).padStart(2, '0')}
              </p>
              <ul class="mt-1 space-y-1 ml-4">
                ${articles.map((article) => `
                  <li class="text-sm">
                    <a href="${escapeHtml(article.url)}" target="_blank" rel="noopener noreferrer"
                       class="text-zinc-700 dark:text-zinc-300 hover:text-teal-500 dark:hover:text-teal-400">
                      ${escapeHtml(article.title)} (${escapeHtml(article.domain)})
                    </a>
                  </li>
                `).join('')}
              </ul>
            </div>
          `).join('')}
        </div>
      </details>
    `
  }

  const renderMonth = (month: ReturnType<typeof processYearData>[number]) => {
    return `
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-zinc-700 dark:text-zinc-300 mb-2">
          ${month.name}
        </h3>
        <div class="relative" style="height:200px">
          <canvas data-chart-id="${month.name}"></canvas>
        </div>
        ${renderArticleList(month)}
      </div>
    `
  }

  const renderYear = (year: number, months: ReturnType<typeof processYearData>) => {
    return `
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100 mb-6">
          ${year}
        </h2>
        ${months.map((month) => renderMonth(month)).join('')}
      </section>
    `
  }

  const init = async () => {
    await waitForChartJs()

    const container = document.getElementById('charts-container')!
    const currentYear = new Date().getFullYear()

    const yearEntries: { year: number; data: any }[] = []
    for (let y = START_YEAR; y <= currentYear; y++) {
      const data = await fetchYearData(y)
      if (data) yearEntries.push({ year: y, data })
    }

    if (yearEntries.length === 0) {
      container.innerHTML = '<p class="text-zinc-500 dark:text-zinc-400">No reading data available.</p>'
      return
    }

    // Process all year data
    const yearData = yearEntries.reverse().map(({ year, data }) => ({
      year,
      months: processYearData(year, data),
    }))

    // Render HTML
    container.innerHTML = yearData
      .map(({ year, months }) => renderYear(year, months))
      .join('')

    // Initialize charts on rendered canvases
    const yearSections = container.querySelectorAll('section')
    for (const { year, months } of yearData) {
      for (const sec of yearSections) {
        if (sec.querySelector('h2')?.textContent?.trim() === String(year)) {
          for (const month of months) {
            const canvas = sec.querySelector<HTMLCanvasElement>(
              `canvas[data-chart-id="${month.name}"]`,
            )
            if (canvas) createChart(canvas, month.labels, month.counts, month.tooltips)
          }
        }
      }
    }
  }

  init()
</script>
